<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#667eea">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="UPI-4">

    <title>Controle de Alimenta√ß√£o</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: radial-gradient(circle at top, #dbeafe 0, #eff6ff 40%, #f9fafb 100%);
  min-height: 100vh;
  padding: 24px;
}


.container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    overflow: hidden;
}

.header {
    background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
    color: white;
    padding: 30px;
    text-align: center;
    position: relative;
}

.header h1 {
    font-size: 2em;
    margin-bottom: 10px;
}

.header p {
    opacity: 0.9;
    font-size: 1.1em;
}

.btn-logout {
    position: absolute;
    top: 20px;
    right: 20px;
    background: #f56565;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    z-index: 1000;
}

.btn-logout:hover {
    background: #e53e3e;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(245, 101, 101, 0.4);
}

.upload-section {
    padding: 20px 30px;
    background: #f7fafc;
    border-bottom: 2px solid #e2e8f0;
}

.upload-container {
    display: flex;
    align-items: center;
    gap: 15px;
}

.file-input-wrapper {
    position: relative;
    overflow: hidden;
    display: inline-block;
}

.file-input-wrapper input[type=file] {
    position: absolute;
    left: -9999px;
}

.file-input-label {
    background: #4299e1;
    color: white;
    padding: 12px 25px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    display: inline-block;
}

.file-input-label:hover {
    background: #3182ce;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(66, 153, 225, 0.4);
}

.file-name {
    color: #4a5568;
    font-style: italic;
}

.content {
    padding: 30px;
}

.table-wrapper {
    overflow-x: auto;
    margin-bottom: 30px;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

thead {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
}

th {
    padding: 15px;
    text-align: left;
    font-weight: 600;
    font-size: 0.95em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

td {
    padding: 12px 15px;
    border-bottom: 1px solid #e2e8f0;
}

tbody tr:hover {
    background: #f7fafc;
}

tbody tr:last-child td {
    border-bottom: none;
}

input[type="number"],
input[type="text"],
select {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.3s;
}

input[type="number"]:focus,
input[type="text"]:focus,
select:focus {
    outline: none;
    border-color: #4299e1;
    box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
}

.total-cell {
    font-weight: 600;
    color: #2d3748;
    background: #edf2f7;
}

.buttons-container {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 20px;
}

button {
    padding: 12px 30px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-save {
    background: #48bb78;
    color: white;
}

.btn-save:hover {
    background: #38a169;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
}

.btn-clear {
    background: #f56565;
    color: white;
}

.btn-clear:hover {
    background: #e53e3e;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(245, 101, 101, 0.4);
}

.btn-print {
    background: #667eea;
    color: white;
}

.btn-print:hover {
    background: #5a67d8;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.btn-add-row {
    background: #ed8936;
    color: white;
}

.btn-add-row:hover {
    background: #dd6b20;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(237, 137, 54, 0.4);
}

.btn-delete {
    background: #fc8181;
    color: white;
    padding: 6px 12px;
    font-size: 12px;
}

.btn-delete:hover {
    background: #f56565;
}

.btn-voltar {
    background: #4299e1;
    color: white;
}

.btn-voltar:hover {
    background: #3182ce;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(66, 153, 225, 0.4);
}

.summary {
    background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
    color: white;
    padding: 25px;
    border-radius: 10px;
    margin-top: 30px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.summary-item {
    text-align: center;
}

.summary-label {
    font-size: 0.9em;
    opacity: 0.9;
    margin-bottom: 5px;
}

.summary-value {
    font-size: 2em;
    font-weight: bold;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s;
}

.modal-content {
    background-color: white;
    margin: 15% auto;
    padding: 30px;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    animation: slideIn 0.3s;
}

.modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.print-value {
    display: none;
}

@media print {
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    html, body {
        width: 297mm;
        height: 210mm;
        margin: 0;
        padding: 0;
        background: white;
    }

    .container {
        box-shadow: none;
        max-width: 100%;
        width: 100%;
        margin: 0;
        padding: 8mm;
        height: 100%;
        box-sizing: border-box;
    }

    .upload-section,
    .buttons-container,
    .btn-delete,
    .action-cell,
    .btn-voltar,
    .btn-logout,
    th:last-child,
    td:last-child {
        display: none !important;
    }

    input {
        display: none !important;
    }
    
    .print-value {
        display: inline-block !important;
        font-weight: bold;
        font-size: 10pt;
        color: #000 !important;
        width: 100%;
        text-align: center;
    }

    .header {
        background: #2d3748 !important;
        color: white !important;
        padding: 8px;
        margin-bottom: 10px;
        text-align: center;
        border: 2px solid #000;
    }

 .header-date {
    font-size: 11pt !important;
    opacity: 1 !important;
    margin-top: 3px !important;
  }

    .header h1 {
        font-size: 16pt;
        margin: 0;
        font-weight: bold;
    }

    .header p {
        font-size: 11pt;
        margin: 2px 0 0 0;
    }

    .table-wrapper {
        border: 3px solid #000 !important;
        margin-bottom: 10px;
        page-break-inside: avoid;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10pt;
        border: none;
    }

    thead {
        background: #48bb78 !important;
        color: white !important;
    }

    th {
        padding: 8px 5px;
        font-size: 10pt;
        font-weight: bold;
        border: 2px solid #000 !important;
        text-align: center;
        text-transform: uppercase;
        background: #48bb78 !important;
        color: white !important;
    }

    td {
        padding: 6px 5px;
        border: 2px solid #000 !important;
        text-align: center;
        font-size: 10pt;
        background: white !important;
    }

    .total-cell {
        background: #f0f0f0 !important;
        font-weight: bold;
        color: #000 !important;
    }

    .summary {
        background: #4299e1 !important;
        color: white !important;
        padding: 10px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        border: 3px solid #000 !important;
        page-break-inside: avoid;
    }

    .summary-item {
        text-align: center;
        flex: 1;
    }

    .summary-label {
        font-size: 9pt;
        font-weight: normal;
        margin-bottom: 3px;
    }

    .summary-value {
        font-size: 20pt;
        font-weight: bold;
    }

    @page {
        size: A4 landscape;
        margin: 10mm;
    }

    .content {
        page-break-inside: avoid;
    }

    tr {
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group;
    }

    th:nth-child(1), td:nth-child(1) { width: 25%; }
    th:nth-child(2), td:nth-child(2) { width: 17%; }
    th:nth-child(3), td:nth-child(3) { width: 17%; }
    th:nth-child(4), td:nth-child(4) { width: 17%; }
    th:nth-child(5), td:nth-child(5) { width: 17%; }
}

/* ============================================ */
/* RESPONSIVIDADE */
/* ============================================ */

/* ESTILOS BASE - Desktop */
.header {
    position: relative; /* ‚Üê CR√çTICO: Adicionar isso */
    background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
    color: white;
    padding: 30px;
    text-align: center;
}

.btn-logout {
    position: absolute;
    top: 20px;
    right: 20px;
    background: #f56565;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    z-index: 1000;
}

.btn-logout:hover {
    background: #e53e3e;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(245, 101, 101, 0.4);
}

/* Tablets e telas m√©dias (max-width: 1024px) */
@media (max-width: 1024px) {
    .container {
        max-width: 95%;
    }

    .header h1 {
        font-size: 1.5em;
    }

    .modules-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .dashboard-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
    }

    .user-info {
        text-align: center;
    }
}

/* Tablets pequenos e celulares grandes (max-width: 768px) */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }
    
    .header {
        padding: 50px 15px 20px 15px; /* Espa√ßo no topo para o bot√£o */
    }

    .header h1 {
        font-size: 1.4em;
    }

    .header p {
        font-size: 0.95em;
    }
    
    .header-date {
        font-size: 0.9em;
    }

    .btn-logout {
        top: 10px;
        right: 10px;
        padding: 8px 15px;
        font-size: 13px;
    }

    .btn-voltar {
        padding: 10px 20px;
        font-size: 14px;
    }

    .content {
        padding: 15px;
    }

    .upload-section {
        padding: 15px 20px;
    }

    .upload-container {
        flex-direction: column;
        align-items: flex-start;
    }

    .table-wrapper {
        overflow-x: scroll;
        -webkit-overflow-scrolling: touch;
    }

    table {
        font-size: 12px;
        min-width: 600px;
    }

    th, td {
        padding: 8px 10px;
    }

    input[type="number"],
    input[type="text"] {
        font-size: 12px;
        padding: 6px 10px;
    }

    .buttons-container {
        flex-direction: column;
        gap: 10px;
    }

    button {
        width: 96%;
        justify-content: center;
    }

    .summary {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        padding: 15px;
    }

    .summary-value {
        font-size: 1.5em;
    }

    .modules-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .module-card {
        padding: 20px;
    }

    .module-icon {
        font-size: 2.5em;
    }

    .module-title {
        font-size: 1.3em;
    }

    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .stat-card-value {
        font-size: 20px;
    }

    .distribution-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
    }
}

/* Celulares pequenos (max-width: 480px) */
@media (max-width: 480px) {
    .header {
        padding: 50px 10px 20px 10px;
    }

    .header h1 {
        font-size: 1.2em; /* ‚Üê Ajustado de 1.12em para 1.2em */
        line-height: 1.3;
    }

    .header p {
        font-size: 0.85em;
    }
    
    .header-date {
        font-size: 0.8em;
    }

    .btn-logout {
        top: 8px;
        right: 8px;
        padding: 6px 12px;
        font-size: 12px;
    }

    .login-container {
        padding: 25px;
    }

    .login-header h1 {
        font-size: 1.5em;
    }

    .file-input-label {
        padding: 10px 20px;
        font-size: 14px;
    }

    table {
        font-size: 10px;
    }

    th, td {
        padding: 6px 8px;
    }

    .summary {
        grid-template-columns: 1fr;
        gap: 10px;
    }

    .summary-label {
        font-size: 0.8em;
    }

    .summary-value {
        font-size: 1.3em;
    }

    .module-icon {
        font-size: 2em;
    }

    .module-title {
        font-size: 1.1em;
    }

    .module-description {
        font-size: 0.9em;
    }

    button {
        padding: 10px 20px;
        font-size: 14px;
    }

    .modal-content {
        padding: 20px;
        width: 95%;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .stat-card {
        padding: 15px;
    }
}

/* Celulares muito pequenos (max-width: 360px) */
@media (max-width: 360px) {
    .header {
        padding: 45px 8px 15px 8px;
    }
    
    .header h1 {
        font-size: 1.1em;
    }
    
    .btn-logout {
        top: 6px;
        right: 6px;
        padding: 5px 10px;
        font-size: 11px;
    }
}

/* Modo paisagem em celulares */
@media (max-height: 500px) and (orientation: landscape) {
    .header {
        padding: 45px 15px 15px 15px;
    }
    
    .header h1 {
        font-size: 1.2em;
    }
    
    .btn-logout {
        top: 5px;
        right: 10px;
        padding: 5px 10px;
        font-size: 11px;
    }

    .login-container {
        max-height: 90vh;
        overflow-y: auto;
    }

    .content {
        padding: 15px;
    }
}

/* Ajustes para impress√£o em dispositivos m√≥veis */
@media print {
    @page {
        size: A4 landscape;
        margin: 10mm;
    }

    html, body {
        width: 100%;
        height: 100%;
    }
}



    </style>
</head>
<script>
  // Registra o Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => {
          console.log('Service Worker registrado com sucesso:', registration.scope);
        })
        .catch(error => {
          console.log('Falha ao registrar Service Worker:', error);
        });
    });
  }
</script>

<body>
    <div class="container">
        <div class="header">
            <button id="btnLogout" class="btn-logout">üö™ Sair</button>
            <h1>üçΩÔ∏è Controle de Distribui√ß√£o de Alimenta√ß√£o</h1>
            <p class="header-date" id="headerDate"><span id="currentCity">Carregando...</span>, <span id="currentDate"></span></p>
        </div>

        <div class="upload-section">
            <div class="upload-container">
                <div class="file-input-wrapper">
                    <label for="fileInput" class="file-input-label">
                        üìÅ Carregar Arquivo Excel
                    </label>
                    <input type="file" id="fileInput" accept=".xls,.xlsx" />
                </div>
                <span class="file-name" id="fileName">Nenhum arquivo selecionado</span>
            </div>
        </div>

        <div class="content">
            <div class="table-wrapper">
                <table id="tabelaAlimentacao">
                    <thead>
                        <tr>
                            <th>Ala</th>
                            <th>Qtd. Internos</th>
                            <th>Caixas (42un)</th>
                            <th>Normal</th>
                            <th>Dietas</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaBody">
                        <!-- Linhas geradas dinamicamente -->
                    </tbody>
                </table>
            </div>

            <div class="buttons-container">
               <button class="btn-voltar" id="btnVoltar">
                    ‚¨ÖÔ∏è Voltar ao Dashboard
                </button>
                <button class="btn-add-row" id="btnAddRow">
                    ‚ûï Adicionar Nova Ala
                </button>
                <button class="btn-save" id="btnSalvar">
                    üíæ Salvar Dados
                </button>
                <button onclick="limparDados()"class="btn-clear" id="btnLimpar">
                    üóëÔ∏è Limpar Tudo
                </button>
                <button class="btn-print" id="btnImprimir">
                    üñ®Ô∏è Imprimir PDF
                </button>
            </div>

            <div class="summary" id="summary">
                <div class="summary-item">
                    <div class="summary-label">Total de Internos</div>
                    <div class="summary-value" id="totalInternos">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total de Quentinhas</div>
                    <div class="summary-value" id="totalQuentinhas">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total de Caixas</div>
                    <div class="summary-value" id="totalCaixas">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2>‚ö†Ô∏è Confirmar A√ß√£o</h2>
            <p id="confirmMessage"></p>
            <div class="modal-buttons">
                <button class="btn-clear" id="confirmYes">Sim</button>
                <button class="btn-save" id="confirmNo">N√£o</button>
            </div>
        </div>
    </div>

    <script>

// Atualizar data e localiza√ß√£o no header
async function atualizarDataELocalidade() {
    // Atualizar data
    const hoje = new Date();
    const dia = String(hoje.getDate()).padStart(2, '0');
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    const ano = hoje.getFullYear();
    
    const dataFormatada = `${dia}/${mes}/${ano}`;
    const elementoData = document.getElementById('currentDate');
    
    if (elementoData) {
        elementoData.textContent = dataFormatada;
    }
    
    // Obter localiza√ß√£o
    obterLocalidadePrecisa();
}

// Coordenadas de cidades conhecidas da regi√£o (atualizadas)
const CIDADES_CONHECIDAS = {
    'Itaitinga': { lat: -3.7421, lon: -38.5188 }      // Coordenadas corrigidas baseadas na sua localiza√ß√£o
};


// Fun√ß√£o para calcular dist√¢ncia entre dois pontos (em km)
function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371; // Raio da Terra em km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Fun√ß√£o para identificar cidade mais pr√≥xima
function identificarCidadeProxima(lat, lon) {
    let cidadeMaisProxima = null;
    let menorDistancia = Infinity;
    
    for (const [nome, coords] of Object.entries(CIDADES_CONHECIDAS)) {
        const distancia = calcularDistancia(lat, lon, coords.lat, coords.lon);
        
        if (distancia < menorDistancia) {
            menorDistancia = distancia;
            cidadeMaisProxima = nome;
        }
    }
    
    // Se estiver a menos de 10km, usar a cidade identificada
    if (menorDistancia < 10) {
        return cidadeMaisProxima;
    }
    
    return null;
}

// Fun√ß√£o para obter localidade com precis√£o
function obterLocalidadePrecisa() {
    const elementoCidade = document.getElementById('currentCity');
    
    if (!elementoCidade) return;
    
    // Verificar se o navegador suporta geolocaliza√ß√£o
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
            // Sucesso
            async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                console.log('Coordenadas detectadas:', lat, lon); // Debug
                
                // Calcular dist√¢ncia para todas as cidades
                let distancias = [];
                for (const [nome, coords] of Object.entries(CIDADES_CONHECIDAS)) {
                    const distancia = calcularDistancia(lat, lon, coords.lat, coords.lon);
                    distancias.push({ nome, distancia });
                }
                
                // Ordenar por dist√¢ncia (mais pr√≥xima primeiro)
                distancias.sort((a, b) => a.distancia - b.distancia);
                
                console.log('Dist√¢ncias:', distancias); // Debug
                
                // Usar a cidade mais pr√≥xima se estiver a menos de 20km
                if (distancias[0].distancia < 20) {
                    const cidadeEscolhida = distancias[0].nome;
                    console.log('Cidade escolhida:', cidadeEscolhida, `(${distancias[0].distancia.toFixed(2)}km)`);
                    
                    elementoCidade.textContent = cidadeEscolhida;
                    localStorage.setItem('ultimaCidade', cidadeEscolhida);
                    localStorage.setItem('ultimaLat', lat);
                    localStorage.setItem('ultimaLon', lon);
                    return;
                }
                
                // Se n√£o identificou por proximidade, buscar na API
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14&addressdetails=1`,
                        {
                            headers: {
                                'User-Agent': 'Sistema-Prisional-BR'
                            }
                        }
                    );
                    
                    const data = await response.json();
                    console.log('Resposta da API:', data.address); // Debug
                    
                    // Verificar se a API menciona alguma cidade conhecida no endere√ßo
                    const enderecoCompleto = JSON.stringify(data.address).toLowerCase();
                    
                    for (const cidade of Object.keys(CIDADES_CONHECIDAS)) {
                        if (enderecoCompleto.includes(cidade.toLowerCase())) {
                            console.log('Cidade encontrada na API:', cidade);
                            elementoCidade.textContent = cidade;
                            localStorage.setItem('ultimaCidade', cidade);
                            return;
                        }
                    }
                    
                    // Extrair cidade do resultado da API
                    const cidade = data.address.city || 
                                   data.address.town || 
                                   data.address.village || 
                                   data.address.municipality || 
                                   data.address.county ||
                                   data.address.suburb ||
                                   distancias[0].nome; // Fallback para cidade mais pr√≥xima
                    
                    console.log('Cidade final:', cidade);
                    elementoCidade.textContent = cidade;
                    localStorage.setItem('ultimaCidade', cidade);
                    localStorage.setItem('ultimaLat', lat);
                    localStorage.setItem('ultimaLon', lon);
                    
                } catch (error) {
                    console.error('Erro ao obter localidade:', error);
                    // Em caso de erro, usar a cidade mais pr√≥xima
                    if (distancias.length > 0) {
                        elementoCidade.textContent = distancias[0].nome;
                        localStorage.setItem('ultimaCidade', distancias[0].nome);
                    } else {
                        usarCidadePadrao();
                    }
                }
            },
            // Erro
            (error) => {
                console.warn('Geolocaliza√ß√£o negada ou indispon√≠vel:', error.message);
                usarCidadePadrao();
            },
            // Op√ß√µes - alta precis√£o
            {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0 // N√£o usar cache, sempre pegar coordenadas novas
            }
        );
    } else {
        usarCidadePadrao();
    }
}


// Fun√ß√£o auxiliar para usar cidade padr√£o
function usarCidadePadrao() {
    const elementoCidade = document.getElementById('currentCity');
    if (!elementoCidade) return;
    
    // Tentar usar a √∫ltima cidade salva
    const cidadeSalva = localStorage.getItem('ultimaCidade');
    
    if (cidadeSalva) {
        elementoCidade.textContent = cidadeSalva;
    } else {
        // Se n√£o houver nada salvo, mostrar mensagem
        elementoCidade.textContent = 'Localiza√ß√£o n√£o detectada';
    }
}

// Chamar a fun√ß√£o ao carregar a p√°gina
atualizarDataELocalidade();


       // Verificar autentica√ß√£o antes de carregar
if (!sessionStorage.getItem('usuarioLogado')) {
    window.location.href = 'index.html';
}

// ============================================
// CONSTANTES E CONFIGURA√á√ïES
// ============================================
const CAIXA_CAPACIDADE = 42;
const tabelaBody = document.getElementById('tabelaBody');
const fileInput = document.getElementById('fileInput');
const fileName = document.getElementById('fileName');
const btnSalvar = document.getElementById('btnSalvar');
const btnLimpar = document.getElementById('btnLimpar');
const btnImprimir = document.getElementById('btnImprimir');
const btnAddRow = document.getElementById('btnAddRow');
const btnVoltar = document.getElementById('btnVoltar');
const btnLogout = document.getElementById('btnLogout');
const confirmModal = document.getElementById('confirmModal');
const confirmMessage = document.getElementById('confirmMessage');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');

let dadosAlas = [];
let nextId = 1;
let confirmCallback = null;

// Dados iniciais baseados no Excel
const alasIniciais = [
    { id: nextId++, nome: 'A', internos: 0, dietas: 0 },
    { id: nextId++, nome: 'B', internos: 0, dietas: 0 },
    { id: nextId++, nome: 'C', internos: 0, dietas: 0 },
    { id: nextId++, nome: 'D', internos: 0, dietas: 0 },
    { id: nextId++, nome: 'E', internos: 0, dietas: 0 },
    { id: nextId++, nome: 'F', internos: 0, dietas: 0 },
    { id: nextId++, nome: 'SEGURAN√áA A', internos: 0, dietas: 0 },
    { id: nextId++, nome: 'SEGURAN√áA B', internos: 0, dietas: 0 },
    { id: nextId++, nome: 'ENFERMARIA', internos: 0, dietas: 0 }
];

// ============================================
// MODAL DE CONFIRMA√á√ÉO
// ============================================
function mostrarModal(mensagem, callback) {
    confirmMessage.textContent = mensagem;
    confirmCallback = callback;
    confirmModal.style.display = 'block';
}

function fecharModal() {
    confirmModal.style.display = 'none';
    confirmCallback = null;
}

confirmYes.addEventListener('click', () => {
    if (confirmCallback) confirmCallback();
    fecharModal();
});

confirmNo.addEventListener('click', fecharModal);

window.addEventListener('click', (e) => {
    if (e.target === confirmModal) {
        fecharModal();
    }
});

// ============================================
// FUN√á√ïES DE C√ÅLCULO
// ============================================
function calcularTotaisAla(ala) {
    const internosNormais = ala.internos - ala.dietas;
    const caixas = Math.floor(internosNormais / CAIXA_CAPACIDADE);
    const normal = internosNormais % CAIXA_CAPACIDADE;
    const totalQuentinhas = ala.internos;
    return { normal, totalQuentinhas, caixas };
}

// ============================================
// PERSIST√äNCIA DE DADOS
// ============================================
function carregarDoStorage() {
    const salvo = localStorage.getItem('controleAlimentacaoUPI4');
    if (salvo) {
        const dados = JSON.parse(salvo);
        dadosAlas = dados.alas;
        nextId = dados.nextId || nextId;
    } else {
        dadosAlas = [...alasIniciais];
    }
    renderTabela();
    atualizarResumo();
}

function salvarNoStorage() {
    const dados = {
        alas: dadosAlas,
        nextId: nextId
    };
    localStorage.setItem('controleAlimentacaoUPI4', JSON.stringify(dados));
    alert('‚úÖ Dados salvos com sucesso!');
}


function limparDados() {
    mostrarModal('Deseja realmente limpar todos os dados?', () => {
        dadosAlas = [...alasIniciais];
        nextId = 10;
        localStorage.removeItem('controleAlimentacaoUPI4');
        
        // ‚úÖ Recarrega a p√°gina
        location.reload();
    });
}


// ============================================
// GEST√ÉO DE ALAS
// ============================================
function adicionarNovaAla() {
    const novaAla = {
        id: nextId++,
        nome: `Nova Ala ${dadosAlas.length + 1}`,
        internos: 0,
        dietas: 0
    };
    dadosAlas.push(novaAla);
    renderTabela();
    atualizarResumo();
}

function deletarAla(id) {
    mostrarModal('Deseja realmente deletar esta ala?', () => {
        dadosAlas = dadosAlas.filter(ala => ala.id !== id);
        renderTabela();
        atualizarResumo();
    });
}

function atualizarRegistro(id, campo, valor) {
    const ala = dadosAlas.find(a => a.id === id);
    if (!ala) return;
    
    ala[campo] = valor;
    
    const input = document.querySelector(`[data-id="${id}"][data-campo="${campo}"]`);
    if (!input) return;
    
    const tr = input.closest('tr');
    
    const internosNormais = ala.internos - ala.dietas;
    const caixas = Math.floor(internosNormais / CAIXA_CAPACIDADE);
    const normal = internosNormais % CAIXA_CAPACIDADE;
    
    const normalCell = tr.querySelector('.normal-cell');
    const caixasCell = tr.querySelector('.caixas-cell');
    
    if (normalCell) normalCell.textContent = normal;
    if (caixasCell) caixasCell.textContent = caixas;
    
    atualizarResumo();
}

// ============================================
// RENDERIZA√á√ÉO
// ============================================
function renderTabela() {
    tabelaBody.innerHTML = '';
    
    dadosAlas.forEach(ala => {
        const { normal, totalQuentinhas, caixas } = calcularTotaisAla(ala);
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <input 
                    type="text" 
                    value="${ala.nome}" 
                    data-id="${ala.id}" 
                    data-campo="nome"
                    class="input-ala-nome"
                    placeholder="Nome da Ala"
                />
                <span class="print-value">${ala.nome}</span>
            </td>
            <td>
                <input 
                    type="number" 
                    min="0" 
                    step="1"
                    value="${ala.internos}" 
                    data-id="${ala.id}" 
                    data-campo="internos"
                    class="input-internos"
                />
                <span class="print-value">${ala.internos}</span>
            </td>
            <td class="total-cell caixas-cell">${caixas}</td>
            <td class="total-cell normal-cell">${normal}</td>
            <td>
                <input 
                    type="number" 
                    min="0" 
                    step="1"
                    value="${ala.dietas}" 
                    data-id="${ala.id}" 
                    data-campo="dietas"
                    class="input-dietas"
                    placeholder="Qtd. Dietas"
                />
                <span class="print-value">${ala.dietas}</span>
            </td>
            <td class="action-cell">
                <button class="btn-delete" data-id="${ala.id}">üóëÔ∏è Deletar</button>
            </td>
        `;
        
        tabelaBody.appendChild(tr);
    });
    
    document.querySelectorAll('.input-ala-nome, .input-internos, .input-dietas').forEach(input => {
        input.addEventListener('input', (e) => {
            const id = parseInt(e.target.dataset.id);
            const campo = e.target.dataset.campo;
            let valor = e.target.value;
            
            if (campo === 'internos' || campo === 'dietas') {
                valor = parseInt(valor) || 0;
            }
            
            atualizarRegistro(id, campo, valor);
            
            const span = e.target.nextElementSibling;
            if (span && span.classList.contains('print-value')) {
                span.textContent = valor;
            }
        });
    });
    
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = parseInt(e.target.dataset.id);
            deletarAla(id);
        });
    });
}

function atualizarResumo() {
    let totalInternos = 0;
    let totalQuentinhas = 0;
    let totalCaixas = 0;
    let totalQuentinhasCompleto = 0; // Nova vari√°vel para somar TUDO
    
    dadosAlas.forEach(ala => {
        const { normal, totalQuentinhas: qtd, caixas } = calcularTotaisAla(ala);
        totalInternos += ala.internos;
        totalQuentinhas += qtd;
        
        // Somar: (Caixas * 48) + Normal + Dietas
        totalQuentinhasCompleto += (caixas * CAIXA_CAPACIDADE) + normal + ala.dietas;
    });
    
    // Calcular caixas e unidades do total
    const caixasCompletas = Math.floor(totalQuentinhasCompleto / CAIXA_CAPACIDADE);
    const unidadesAvulsas = totalQuentinhasCompleto % CAIXA_CAPACIDADE;
    
    document.getElementById('totalInternos').textContent = totalInternos;
    document.getElementById('totalQuentinhas').textContent = totalQuentinhas;
    
    // Exibir no formato "xx caixas e yy unidades"
    const textoCaixas = `${caixasCompletas} cx e ${unidadesAvulsas} un`;
    document.getElementById('totalCaixas').textContent = textoCaixas;
}

// ============================================
// UPLOAD DE EXCEL
// ============================================
fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    fileName.textContent = file.name;
    
    const reader = new FileReader();
    reader.onload = (evt) => {
        try {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            const primeiraAba = workbook.SheetNames[0];
            const folha = workbook.Sheets[primeiraAba];
            const json = XLSX.utils.sheet_to_json(folha);
            
            const mapaContagem = {};
            
            json.forEach(linha => {
                if (linha['Unidade'] !== 'UP - ITAITINGA 4') return;
                const ultLoc = String(linha['Ult. Localiza√ß√£o'] || '');
                
                let ala = null;
                const match = ultLoc.match(/Ala\s+([^-]+)/i);
                if (match) {
                    ala = match[1].trim().toUpperCase();
                }
                
                if (!ala) return;
                
                if (['A', 'B', 'C', 'D', 'E', 'F'].includes(ala)) {
                    ala = ala;
                } else if (ala.includes('SEGURAN√áA A') || ala === 'SEGURAN√áA A') {
                    ala = 'SEGURAN√áA A';
                } else if (ala.includes('SEGURAN√áA B') || ala === 'SEGURAN√áA B') {
                    ala = 'SEGURAN√áA B';
                } else if (ala.includes('ENFERMARIA')) {
                    ala = 'ENFERMARIA';
                } else {
                    return;
                }
                
                mapaContagem[ala] = (mapaContagem[ala] || 0) + 1;
            });
            
            Object.keys(mapaContagem).forEach(nomeAla => {
                const alaExistente = dadosAlas.find(a => a.nome === nomeAla);
                if (alaExistente) {
                    alaExistente.internos = mapaContagem[nomeAla];
                } else {
                    dadosAlas.push({
                        id: nextId++,
                        nome: nomeAla,
                        internos: mapaContagem[nomeAla],
                        dietas: 0
                    });
                }
            });
            
            renderTabela();
            atualizarResumo();
            alert('‚úÖ Arquivo Excel carregado com sucesso!');
            
        } catch (error) {
            alert('‚ùå Erro ao ler arquivo: ' + error.message);
        }
    };
    
    reader.readAsArrayBuffer(file);
});

// ============================================
// EVENT LISTENERS
// ============================================
btnSalvar.addEventListener('click', salvarNoStorage);
btnLimpar.addEventListener('click', limparDados);
btnImprimir.addEventListener('click', () => window.print());
btnAddRow.addEventListener('click', adicionarNovaAla);
btnVoltar.addEventListener('click', () => window.location.href = 'index.html');

btnLogout.addEventListener('click', () => {
    if (confirm('Deseja realmente sair do sistema?')) {
        sessionStorage.removeItem('usuarioLogado');
        window.location.href = 'index.html';
    }
});

// ============================================
// INICIALIZA√á√ÉO
// ============================================
carregarDoStorage();



    </script>
</body>
</html>
